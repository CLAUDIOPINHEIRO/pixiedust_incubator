{%extends "basedialog.html"%}
{%block title %}Twitter Sentiment Analysis{%endblock%}

{%block body%}
  <style>
    #demo .tab-pane-stream > .row:first-child {
      height: 10vh;
      max-height: 10vh;
      min-height: 10vh;
    }
    #demo .tab-pane-stream > .row:nth-child(2) {
      height: 60vh;
      max-height: 60vh;
      min-height: 60vh;
    }
    .chart-wrapper {
      background: #fff;
      margin: 10px;
      padding: 10px;
    }
    .chart-wrapper .chart-title {
      border-bottom: 1px solid #152935;
      color: #152935;
      font-size: 1.25em;
      font-weight: 400;
      padding: 10px 0px 5px;
    }
    .chart-wrapper .chart-stage {
      overflow: hidden;
      position: relative;
      margin: 10px 0px 5px;
    }
    .twitter-cards,
    .stream-log {
      height: 100%;
    }
    .twitter-cards .chart-stage {
      height: calc(100% - 30px);
      margin-top: 0px;
      overflow: auto;
    }
    .stream-log .chart-stage {
      height: calc(100% - 40px);
      overflow: auto;
    }
    .stream-log .chart-stage * {
      background: transparent;
      display: block;
      font-family: monospace;
      white-space: pre;
    }
    .trending-sentiments {
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .trending-hashtags,
    .trending-sentiments {
      height: 100%;
    }
    .trending-hashtags .chart-stage,
    .trending-sentiments .chart-stage {
      height: calc(100% - 50px);
      overflow: auto;
    }
    .twitter-cards-msg {
      float: right;
      font: 400 11px/25px "Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    .streaming-spinner {
      color: #fff;
      font-size: 24px;
      margin-top: 2px;
    }
    .twitter-cards-list {
      list-style: none;
      padding: 0 10px;
    }
    .twitter-cards-list li.row {
      background: #ffffff none repeat scroll 0 0;
      border-left: 3px solid #4178be;
      box-shadow: 1px 2px 7px 1px rgba(0, 0, 0, 0.25);
      color: #1d3649;
      padding: 10px 15px 15px;
      margin: 10px 0 20px;
    }
    .twitter-cards-list li.row > div:nth-child(2) {
      padding-left: 10px;
    }
    .twitter-card-pic {
      min-height: 50px;
    }
    .twitter-card-name {
      color: #323232;
      font: 500 14px "Helvetica Neue",Helvetica,Arial,sans-serif;
      letter-spacing: 0.5px;
      padding-bottom: 3px;
    }
    .twitter-card-tweet {
      color: #1d3649;
      font: 400 16px/1.2 "Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    .twitter-filter label {
      color: #1d3649;
      font: 400 24px/36px "Helvetica Neue",Helvetica,Arial,sans-serif;
      left: 0;
      margin: 0;
      position: absolute;
    }
    .twitter-filter input {
      border: medium none;
      border-bottom: 2px solid #1d3649;
      color: #1d3649;
      display: inline-block;
      font-size: 1.25em;
      font-weight: 400;
      padding: 0.5em 25px;
    }
    .twitter-filter input:focus,
    .twitter-filter input.focus {
      border-color: #a6266e;
    }
    .full-box {
      height: calc(100% - 10px);
    }
    .half-box {
      height: calc(50% + 5px);
    }
    .simple-box {
      background-color: transparent !important;
      border: 0 none !important;
      margin: 0;
      padding: 0 !important;
    }
    .pixiedust .modal-header {
      background-color: #152935;
      color: #ffffff;
    }
    .pixiedust .modal-body {
      padding: 10px;
    }
    .pixiedust .modal-dialog .btn.focus,
    .pixiedust .modal-dialog .btn:focus {
      outline: none;
    }
    .pixiedust .modal-dialog .btn-cancel,
    .pixiedust .modal-dialog .btn-ok {
      display: none;
    }
    .pixiedust .modal-dialog .btn-back {
      background-color: #082632;
      border: 2px solid #082632;
      color: #fff;
      font-weight: 500;
      padding: 0.625em 1.375em;
    }
    .pixiedust .modal-dialog .btn-back:hover {
      background-color: #fff;
      border-color: #082632;
      color: #082632;
    }
    .pixiedust .modal-dialog .btn-start {
      background-color: #fff;
      border: 2px solid #a6266e;
      color: #a6266e;
      font-weight: 500;
      padding: 0.625em 1.375em;
    }
    .pixiedust .modal-dialog .btn-start:hover {
      background-color: #a6266e;
      border-color: #a6266e;
      color: #fff;
    }
    .pixiedust .modal-dialog .btn-stop {
      background-color: #a6266e;
      border: 2px solid #a6266e;
      color: #fff;
      font-weight: 500;
      padding: 0.625em 1.375em;
    }
    .pixiedust .modal-dialog .btn-stop:hover {
      opacity: 0.65;
    }
    .pixiedust .modal-footer {
      border-top: 0px;
      padding: 20px 30px;
    }
    .pixiedust .modal-dialog svg text {
      fill: black;
      font-size: 11px;
      font-weight: normal;
    }
  </style>
  <div class="tab-content container-fluid" id="demo">
    <div class="tab-pane tab-pane-confirm">
      <p>Streaming is still in progress. Are you sure you want to close?</p>
    </div>
    <div class="tab-pane tab-pane-config">
      <p>Missing configuration. Please add configuration and try again!</p>
    </div>
    <div class="tab-pane tab-pane-stream active">
      <div class="row">
        <div class="col-sm-3">
          <div class="chart-wrapper">
            <div class="chart-stage">
              <button id="startStreamBtn" type="button" class="btn btn-sm btn-start">Start Streaming</button>
            </div>
          </div>
        </div>
        <div class="col-sm-9">
          <div class="chart-wrapper twitter-filter">
            <div class="chart-title simple-box"> </div>
            <div class="chart-stage">
              <input id="twitter-filter-input" name="twitter-filter-input" class="col-sm-12" type="search" placeholder="Filter tweets containing specific words (e.g., Spark)">
              <label for="twitter-filter-input"><i class="fa fa-filter" aria-hidden="true"></i></label>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-3 full-box">
          <div class="chart-wrapper twitter-cards">
            <div class="chart-title">
              <span>Twitter Feed</span> <span class="twitter-cards-msg"> </a></div>
            <div class="chart-stage">
              <ol class="twitter-cards-list">
              </ol>
            </div>
          </div>
        </div>
        <div class="col-sm-6 full-box">
          <div class="row half-box">
            <div class="col-sm-12 full-box">
              <div class="chart-wrapper trending-hashtags">
                <div class="chart-title">Trending Hashtags</div>
                <div class="chart-stage"></div>
              </div>
            </div>
          </div>
          <div class="row half-box">
            <div class="col-sm-12 full-box">
              <div class="chart-wrapper trending-sentiments">
                <div class="chart-title">Trending Sentiments</div>
                <div class="chart-stage"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-3 full-box">
          <div class="chart-wrapper stream-log">
            <div class="chart-title"><span>Streaming Logs</span></div>
            <div class="chart-stage"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
{%endblock%}

{%block onCancel%}
  $('#demoScript{{prefix}}').remove();
  $('#results{{prefix}}').html('<p class="text-center">Twitter Sentiment has been cancelled.</p>');
  $('#loading{{prefix}}').css('display','none');
{%endblock%}

{%block onOK%}
  $('#demoScript{{prefix}}').remove();
  $('#results{{prefix}}').html('<p class="text-center">A dataframe containing your twitter content has been created and added to the cell below.</p>');
  $('#loading{{prefix}}').css('display','none');
{%endblock%}

{%block onDialogShown%}
  window.Pixiedust = window.Pixiedust || {};
  window.Pixiedust.twitterdemo = window.Pixiedust.twitterdemo || {};
  var pix = window.Pixiedust.twitterdemo;

  var tdiag = $(this)
    .find('.modal-dialog')
    .css({
      width:'90%',
    });
  
  var startBtn = $('#startStreamBtn', tdiag);
  var logDiv = $('.stream-log > .chart-stage', tdiag);
  var filterInput = $('#twitter-filter-input', tdiag);
  var resultsDiv = $('#results{{prefix}}');
  var loadingDiv = $('#loading{{prefix}}');
  var cardList = $('.twitter-cards-list');
  var streamingSpinner = $('.pixiedust .modal-header button.close')
    .html('<i class="fa fa-spinner fa-spin streaming-spinner"></i>')
    .prop('disabled', true)
    .css({display: 'none'});
  var pauseCards = false;
  var hiddenCards = [];
  var sentimentColors = {
    joy: '#4178be',
    sadness: '#fc5120',
    fear: '#5da51d'
  }

  var logMsg = function(data) {
    var BEGINSTREAM = '@BEGINSTREAM@';
    var ENDSTREAM = '@ENDSTREAM@';
    function doLogMsg(msg){
      if (msg.indexOf && msg.indexOf(BEGINSTREAM) === 0) {
        updateBtns('started');
      }else if (msg.indexOf && msg.indexOf(ENDSTREAM) === 0) {
        updateBtns('stopped');
      }else{
        logDiv.append('<span>' + msg + '</span>');
      }
    }
    if (Array.isArray(data)){
      data.forEach(function(msg, index){
        doLogMsg(msg);
      });
    }else{
      doLogMsg(data)
    }
  };

  var updateBtns = function(status) {
    switch (status) {
      case 'starting':
        tdiag.attr('data-streaming', 'starting');
        startBtn.prop('disabled', true);
        startBtn.text('Starting...');
        startBtn.attr('class', 'btn btn-sm btn-start');
        streamingSpinner.css({display: 'inline'});
        filterInput.prop('disabled', true)
          .parent().css({'opacity': 0.5});
        break;
      case 'started':
        tdiag.attr('data-streaming', true);
        startBtn.prop('disabled', false);
        startBtn.text('Stop Streaming');
        startBtn.attr('class', 'btn btn-sm btn-stop');
        streamingSpinner.css({display: 'inline'});
        filterInput.prop('disabled', true)
          .parent().css({'opacity': 0.5});
        break;
      case 'stopping':
        tdiag.attr('data-streaming', 'stopping');
        startBtn.prop('disabled', true);
        startBtn.text('Stopping...');
        startBtn.attr('class', 'btn btn-sm btn-stop');
        streamingSpinner.css({display: 'inline'});
        filterInput.prop('disabled', true)
          .parent().css({'opacity': 0.5});
        break;
      case 'stopped':
        tdiag.attr('data-streaming', false);
        startBtn.prop('disabled', false);
        startBtn.text('Start Streaming');
        startBtn.attr('class', 'btn btn-sm btn-start');
        streamingSpinner.css({display: 'none'});
        filterInput.prop('disabled', false)
          .parent().css({'opacity': 1});
        break;
    }
  };

  var processHashtags = function(data) {
    $('.trending-hashtags > .chart-stage > :not(svg)', tdiag).remove();
    pix.piechart('.trending-hashtags > .chart-stage', data[data.length-1]);
  };

  var processSentiments = function(data) {
    $('.trending-sentiments > .chart-stage > :not(svg)', tdiag).remove();
    pix.groupedchart('.trending-sentiments > .chart-stage', data[data.length-1]);
  };

  var initCard = function(card) {
    card.css({display:'list-item'})
      .animate({height: card.get(0).scrollHeight}, function() {
        card.height('auto');
        if (cardList.children('li').length > 50) {
          $('li', cardList).last().remove();
        }
      });
  };

  var showTweets = function(tweets) {
    var template = '<li class="row" style="height:0px; display:none; border-color:{color}">'
      + '<div class="col-sm-2"><div class="chart-wrapper simple-box"><img class="twitter-card-pic" src="{pic}"></div></div>'
      + '<div class="col-sm-10"><div class="chart-wrapper simple-box">'
      + '<div class="twitter-card-name"><a style="color:{color}" href="//twitter.com/{name}" target="_blank">{author}</a></div>'
      + '<p class="twitter-card-tweet">{text}</p>'
      + '</div></div></li>';
    tweets.forEach(function(tweet, index) {
      var t = $(template.replace(/\{(.+?)\}/g, function($0, $1) {
        return tweet.hasOwnProperty($1) ? tweet[$1] : $0;
      }));

      cardList.prepend(t);
      if (!pauseCards) {
        initCard(t);
      }
      else {
        hiddenCards.push(t);
      }
    });
  };
  /*
  var showTweets = function(tweets) {
    var template = '<li class="row" style="height:0px; display:none; border-color:{color}">'
      + '<div class="col-sm-2"><div class="chart-wrapper simple-box"><img class="twitter-card-pic" src="{pic}"></div></div>'
      + '<div class="col-sm-10"><div class="chart-wrapper simple-box">'
      + '<div class="twitter-card-name"><a style="color:{color}" href="//twitter.com/{name}" target="_blank">{author}</a></div>'
      + '<p class="twitter-card-tweet">{text}</p>'
      + '</div></div></li>';

    if (tweets) {
      for (var i in tweets) {
//temp-start
var p = Math.floor((Math.random() * 6) + 1);
if (p % 5 == 1) tweets[i].pic = "http://github.com/mikebroberg.png?size=50";
if (p % 5 == 2) tweets[i].pic = "http://github.com/jessmantaro.png?size=50";
if (p % 5 == 3) tweets[i].pic = "http://github.com/bradnoble.png?size=50";
if (p % 5 == 4) tweets[i].pic = "http://github.com/vabarbosa.png?size=50";
p++;
var s = Math.floor((Math.random() * 3) + 1);
if (p % 3 == 0) tweets[i].sentiment = 'sadness';
if (p % 3 == 1) tweets[i].sentiment = 'joy';
if (p % 3 == 2) tweets[i].sentiment = 'fear';
s++;
//temp-end
        tweets[i].color = sentimentColors[tweets[i].sentiment] || '#152935';
        var t = $(template.replace(/\{(.+?)\}/g, function($0, $1) {
          return tweets[i].hasOwnProperty($1) ? tweets[i][$1] : $0;
        }));
        cardList.prepend(t);
        if (!pauseCards) {
          initCard(t);
        }
        else {
          hiddenCards.push(t);
        }
      }
    }
  };
  */
  pix.register(function(data) {
    if (data) {
      if (data.log) {
        logMsg(data.log);
      }
      if (data.status) {
        updateBtns(data.status);
      }
      if (data.topHashtags) {
        processHashtags(data.topHashtags);
      }
      if (data.toneScores) {
        processSentiments(data.toneScores);
      }
      if (data.tweets) {
        showTweets(data.tweets);
      }
      if (data.stdout){
        console.log("stdout", data.stdout)
      }
    }
  });

  startBtn.click(function() {
    var idx = startBtn.text().indexOf('Start');
    if (idx == -1) {
      pix.stop();
    }
    else {
      pix.start(filterInput.val());
    }
  });

  cardList.hover(
    function() {
      pauseCards = true;
    },
    function() {
      pauseCards = false;
      for (var c in hiddenCards) {
        if (!pauseCards) {
          initCard(hiddenCards[c]);
        }
      }
    }
  );

  filterInput
    .focus(function() {
      tdiag.find('.twitter-filter label').css({color:'#a6266e'})
    })
    .blur(function() {
      tdiag.find('.twitter-filter label').css({color:'#1d3649'})
    });

  var okBtn = $('.btn-ok', tdiag);
  var backBtn = $('<button class="btn btn-default btn-sm btn-primary btn-back">Back to Notebook</button>');
  okBtn.parent().append(backBtn);

  backBtn
    .click(function(event) {
      event.preventDefault();
      /*var streaming = tdiag.attr('data-streaming');
      if (!streaming || streaming.toLowerCase() === 'false') {
        $('.tab-pane-confirm').addClass('active');
        $('.tab-pane-stream').removeClass('active');
        $(this).css({display: 'none'});
      }
      else {*/
        okBtn.click();
      //}
    });
  logMsg(new Date());
{%endblock%}

{%block onDialogHide%}
  window.Pixiedust.twitterdemo.stopCollectData();
{%endblock%}

{%block cellOuputHTML%}
  <div id="loading{{prefix}}" style="display:none">
    <div style="width:100px;height:60px;left:47%;position:relative">
        <i class="fa fa-circle-o-notch fa-spin" style="font-size:48px"></i>
    </div>
    <div style="text-align:center">Generating the notebook cells for the demo. Please wait...</div>
  </div>
  <div id="results{{prefix}}"></div>
{%endblock%}